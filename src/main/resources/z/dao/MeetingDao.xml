<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 작성: 2017-02-22 - 김재녕 -->
<!-- 내용: MeetingDao 기본 쿼리 작성 -->

<mapper namespace="z.dao.MeetingDao">

	<resultMap type="meeting" id="meeting-map">
		<id column="mtnum"			 property="meetingNo" />
		<result column="mnum"   	 property="meetBossNo" />
		<result column="titl" 	 	 property="title" />
		<result column="cont"		 property="content" />
		<result column="mtdesc"  	 property="category" />
		<result column="dline" 	 	 property="deadline" />
		<result column="photo"	 	 property="photo" />
		<result column="mstat"   	 property="meetStat" />
		<result column="floc"		 property="location" />
		<result column="fdate" 	 	 property="date" />
		<result column="ftime" 	 	 property="time" />
		<result column="sdate" 	 	 property="sdate" />
		<result column="edate" 	 	 property="edate" />
 	  <collection property="boardList" ofType="Board">
			<id column="bnum" property="boardNo"/>
 		 	<result column="bmnum" property="memberNo"/>
			<result column="bmtnum" property="meetNo"/>
			<result column="btitl" property="title"/>
			<result column="bcont" property="content"/>
			<collection property="addFileList" ofType="AddFile">
				<id column="fnum" property="fileNo"/>
	      <result column="flink" property="filePath"/>
	      <result column="ftype" property="fileDesc"/>
			</collection>
		</collection>
	</resultMap>

	<!-- 방 개설 시 meet 테이블 데이터 삽입 -->
	<insert id="insertMeet" parameterType="meeting"
		useGeneratedKeys="true" keyColumn="mtnum" keyProperty="meetingNo">
		<!-- 제목(모임명), 모임설명, 이름(모임분류), 투표기한, 사진, 모임 기간 -->
		insert into meet(titl, cont, mtdesc, dline, photo, mstat)
		values(
		#{title},
		#{content},
		#{category},
		#{deadline},
		#{photo},
		'ing'
		)
	</insert>

  <!-- 방 개설 시 time 테이블 데이터 삽입 -->
	<insert id="insertTime" parameterType="meeting">
		insert into time(mtnum, sdate, edate)
		values(
		#{meetingNo},
    	#{sdate},
    	#{edate}
		)
	</insert>
	
	<!-- 방 개설 시 link 테이블 데이터 삽입 -->
	<insert id="insertLink" parameterType="meeting">
		insert into link(mnum, mtnum, boss, stat)
		values(
		#{meetBossNo},
		#{meetingNo},
		'y',
		'n'
		)
	</insert>

	<select id="getListMeetingCards" parameterType="int" resultMap="meeting-map">
		select meet.mtnum, meet.titl, meet.cont, meet.mtdesc, meet.dline, meet.photo, meet.mstat, meet.floc, meet.fdate, meet.ftime
		from link left outer join meet on link.mtnum=meet.mtnum left outer join memb on link.mnum=memb.mnum where link.mnum=#{value};
	</select>

	<select id="getOneMeeting" parameterType="int" resultMap="meeting-map">
		select * from meet where mtnum=#{value};
	</select>
	
	<!-- 완료 모임 상세 정보 가져오기 -->
 	<select id="getDetailMeeting" parameterType="int" resultMap="meeting-map">
	  select me.titl
		      ,me.cont
			    ,me.mtdesc
			    ,me.dline
			    ,me.photo
			    ,me.mstat
			    ,me.floc
			    ,me.fdate
			    ,me.ftime
			    ,bo.bnum as bnum
			    ,bo.mnum as bmnum
			    ,bo.mtnum as bmtnum
			    ,bo.titl as btitl
			    ,bo.cont as bcont
			    ,fi.fnum as fnum
			    ,fi.link as flink
			    ,fi.type as ftype
		  from link li
		  join meet me
		    on li.mtnum = me.mtnum
		  left outer join board bo
		    on bo.mtnum = li.mtnum
		  left outer join file fi
		    on fi.bnum = bo.bnum
		 where li.mtnum = #{meetingNo}
		   and li.mnum = #{memberNo};
  </select>

</mapper>
